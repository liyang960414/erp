# 连接泄漏问题分析报告

## 问题概述

根据日志分析（`logs/erp.log`），系统在物料导入过程中出现了连接泄漏问题。

## 关键时间线

| 时间 | 事件 | 连接池状态 |
|------|------|-----------|
| 00:44:26 | 应用启动 | 活跃: 0/20, 空闲: 11, 总数: 11 |
| 00:44:37 | 物料组数据收集完成（89条） | - |
| 00:44:41 | 物料组导入完成（89条成功） | - |
| 00:44:50 | 物料导入开始（异步批次处理） | **活跃: 9, 总数: 12** |
| 00:45:20 | 连接池检查 | **活跃: 9, 总数: 19, 空闲: 10** |
| 00:46:20 | 连接池检查 | **活跃: 9, 总数: 19, 空闲: 10** |
| 00:46:37 | **连接泄漏检测触发** | 活跃连接占用超过120秒 |

## 问题根因分析

### 1. 事务超时时间过长

**问题：**
- 批次处理的事务超时设置为 120 秒
- HikariCP 的连接泄漏检测阈值也是 120 秒
- 当事务执行接近 120 秒时，会触发连接泄漏警告

**证据：**
```
00:44:50 - 连接开始占用
00:46:37 - 连接泄漏检测触发（约107秒后）
```

### 2. 异步批次处理中的连接管理

**问题：**
- 使用虚拟线程异步处理批次
- 每个批次在独立事务中执行
- 事务完成时间可能接近或超过 120 秒
- EntityManager 会话资源未及时释放

**堆栈跟踪显示：**
```
at com.sambound.erp.service.MaterialImportService.importRootMaterialGroupsWithTransaction(MaterialImportService.java:253)
```

### 3. 监控日志格式错误

**问题：**
- 日志第127行显示：`使用率: {:.2f}%`
- 格式化字符串未正确解析（可能是 SLF4J 格式问题）

## 已实施的修复方案

### 1. 减少事务超时时间

**修改：**
```java
// 从 120 秒减少到 60 秒
writeTemplate.setTimeout(60);
```

**原因：**
- 确保事务在连接泄漏检测阈值（120秒）之前完成
- 如果事务无法在 60 秒内完成，应该分批处理或优化性能

### 2. 优化 EntityManager 管理

**修改：**
```java
// 每处理 200 个物料刷新一次 EntityManager
if (processedInBatch % 200 == 0) {
    entityManager.flush();
}
// 批次结束前再次刷新
entityManager.flush();
```

**原因：**
- 定期刷新可以释放会话资源
- 确保更改及时写入数据库

### 3. 增强异常处理

**修改：**
```java
try {
    writeTemplate.execute(...);
} catch (org.springframework.transaction.TransactionException e) {
    logger.error("批次事务异常（可能是连接池问题）: {}", e.getMessage(), e);
    throw e;
}
```

**原因：**
- 专门捕获事务异常
- 提供更详细的错误信息

### 4. 修复监控日志格式

**修改：**
```java
// 添加 max > 0 检查，避免除零错误
double usageRate = max > 0 ? (double) active / max * 100 : 0;
```

## 建议的进一步优化

### 1. 减少批次大小

如果 60 秒超时仍然不够，可以考虑：
- 将批次大小从 1000 减少到 500
- 或者进一步减少到 300

### 2. 监控连接使用情况

使用已创建的监控端点：
```bash
GET /api/monitor/pool/summary
```

定期检查：
- 活跃连接数
- 等待线程数
- 连接使用率

### 3. 调整 HikariCP 配置（可选）

如果问题持续，可以：
- 增加连接池大小：`maximum-pool-size: 30`
- 减少泄漏检测阈值：`leak-detection-threshold: 60000`（60秒）

**注意：** 减少泄漏检测阈值只是检测更早，不能解决根本问题。

### 4. 添加连接使用监控

在关键方法中添加连接使用监控：
```java
logger.debug("批次开始处理，当前连接池状态: 活跃={}, 空闲={}", 
    poolMXBean.getActiveConnections(), 
    poolMXBean.getIdleConnections());
```

## 验证修复

### 测试步骤

1. **重新启动应用**
2. **执行物料导入**（使用相同的数据）
3. **观察日志：**
   - 检查是否还有连接泄漏警告
   - 确认连接池状态日志格式正确
   - 查看事务完成时间是否在 60 秒内

### 预期结果

- ✅ 不再出现连接泄漏警告
- ✅ 连接池使用率保持在合理范围（< 75%）
- ✅ 监控日志格式正确显示使用率
- ✅ 事务在 60 秒内完成

## 监控指标

### 关键指标

1. **活跃连接数** - 应 < 最大池大小的 80%
2. **等待线程数** - 应始终为 0
3. **连接使用率** - 应 < 75%
4. **事务完成时间** - 应 < 60 秒

### 告警阈值

- ⚠️ 使用率 > 75% - 警告
- 🔴 使用率 > 90% - 严重警告
- 🔴 等待线程数 > 0 - 立即检查

## 总结

连接泄漏问题主要由以下原因导致：

1. **事务超时时间设置过长**（120秒）接近泄漏检测阈值
2. **EntityManager 会话资源未及时释放**
3. **监控日志格式错误**（次要问题）

已通过以下方式修复：

1. ✅ 减少事务超时时间到 60 秒
2. ✅ 添加定期 EntityManager 刷新
3. ✅ 增强异常处理
4. ✅ 修复监控日志格式

建议持续监控连接池状态，确保问题得到彻底解决。

