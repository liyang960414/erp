spring:
  application:
    name: erp
  datasource:
    url: jdbc:postgresql://localhost:5432/erp_db
    username: postgres
    password: liyang960414
    driver-class-name: org.postgresql.Driver
    # HikariCP 连接池配置
    hikari:
      # 使用环境变量避免循环引用
      # 连接池最小空闲连接数（建议与最大连接数相同，避免连接创建开销）
      minimum-idle: ${DB_POOL_MIN_IDLE:10}
      # 连接池最大连接数（根据并发量调整，用于支持大批量导入）
      maximum-pool-size: ${DB_POOL_MAX_SIZE:20}
      # 连接最大存活时间（设置为小于数据库/网络超时时间，建议 20-25 分钟）
      max-lifetime: ${DB_POOL_MAX_LIFETIME:1200000}  # 20分钟（毫秒）
      # 连接空闲超时时间（空闲连接在此时间后被关闭）
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:600000}   # 10分钟（毫秒）
      # 连接获取超时时间（从池中获取连接的最大等待时间）
      connection-timeout: ${DB_POOL_CONNECTION_TIMEOUT:30000}  # 30秒（毫秒）
      # 连接泄漏检测时间（连接在指定时间未关闭将被视为泄漏）
      leak-detection-threshold: ${DB_POOL_LEAK_DETECTION:120000}  # 120秒（毫秒）
      # 连接验证查询（PostgreSQL 推荐使用 SELECT 1）
      connection-test-query: SELECT 1
      # 连接验证超时时间
      validation-timeout: ${DB_POOL_VALIDATION_TIMEOUT:5000}  # 5秒（毫秒）
  jpa:
    hibernate:
      # 使用环境变量避免循环引用
      ddl-auto: ${JPA_DDL_AUTO:update}
    show-sql: ${JPA_SHOW_SQL:false}
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: ${JPA_FORMAT_SQL:true}
        # 批量插入优化配置
        jdbc:
          batch_size: ${HIBERNATE_BATCH_SIZE:50}  # 批量插入大小，建议50-100
          batch_versioned_data: true  # 支持版本化数据的批量更新
        order_inserts: true  # 启用插入排序，提高批量插入性能
        order_updates: true  # 启用更新排序，提高批量更新性能
  servlet:
    multipart:
      enabled: true
      # 使用环境变量避免循环引用
      # 支持300M大文件导入，设置为400MB留有余量
      max-file-size: ${UPLOAD_MAX_FILE_SIZE:400MB}
      max-request-size: ${UPLOAD_MAX_REQUEST_SIZE:400MB}
      file-size-threshold: ${UPLOAD_FILE_SIZE_THRESHOLD:10MB}

server:
  port: ${SERVER_PORT:8080}
  tomcat:
    # 使用环境变量避免循环引用
    max-threads: ${SERVER_TOMCAT_MAX_THREADS:200}
    accept-count: ${SERVER_TOMCAT_ACCEPT_COUNT:100}
    connection-timeout: ${SERVER_TOMCAT_CONNECTION_TIMEOUT:600000} # 10分钟连接超时
    max-connections: ${SERVER_TOMCAT_MAX_CONNECTIONS:10000}
    max-swallow-size: ${SERVER_TOMCAT_MAX_SWALLOW_SIZE:419430400} # 400MB (字节)
    max-http-form-post-size: ${SERVER_TOMCAT_MAX_HTTP_FORM_POST_SIZE:419430400}

jwt:
  # 使用环境变量避免循环引用
  secret: ${JWT_SECRET:mySecretKeyForJWTTokenGenerationAndValidationMustBeAtLeast256Bits}
  expiration: ${JWT_EXPIRATION:86400000} # 24小时

logging:
  level:
    # 使用环境变量避免循环引用
    root: ${LOG_LEVEL_ROOT:INFO}
    com.sambound.erp: ${LOG_LEVEL_APP:INFO}
    com.zaxxer.hikari: ${LOG_LEVEL_HIKARI:INFO}
  file:
    # 直接使用环境变量，避免循环引用。如需配置可通过环境变量 LOGGING_FILE_NAME 设置
    name: ${LOGGING_FILE_NAME:./logs/erp.log}
  logback:
    rollingpolicy:
      # 使用环境变量避免循环引用
      max-file-size: ${LOG_ROLLING_MAX_FILE_SIZE:2MB}
      max-history: ${LOG_ROLLING_MAX_HISTORY:10}
      total-size-cap: ${LOG_ROLLING_TOTAL_SIZE_CAP:100MB}
      # 使用默认值避免循环引用
      file-name-pattern: ${LOG_ROLLING_FILE_NAME_PATTERN:./logs/erp.log.%d{yyyy-MM-dd}.%i}

# 导入任务调度配置
erp:
  import:
    scheduler:
      pool-size: ${ERP_IMPORT_SCHEDULER_POOL_SIZE:4}
      max-concurrent-tasks: ${ERP_IMPORT_SCHEDULER_MAX_CONCURRENT:4}
      queue-capacity: ${ERP_IMPORT_SCHEDULER_QUEUE_CAPACITY:100}
      poll-interval: ${ERP_IMPORT_SCHEDULER_POLL_INTERVAL:2000}
    dependencies:
      material:
        - unit
      bom:
        - material
      purchase-order:
        - material
        - supplier
      sale-order:
        - material
        - supplier
    type-concurrency:
      unit: ${ERP_IMPORT_CONCURRENCY_UNIT:1}
      material: ${ERP_IMPORT_CONCURRENCY_MATERIAL:1}
      bom: ${ERP_IMPORT_CONCURRENCY_BOM:1}
      sub-req-order: ${ERP_IMPORT_CONCURRENCY_SUB_REQ_ORDER:1}

# 添加以下配置
management:
  endpoints:
    web:
      exposure:
        # 使用环境变量避免循环引用
        include: ${MANAGEMENT_ENDPOINTS_INCLUDE:health,info,metrics}
  endpoint:
    health:
      # 使用环境变量避免循环引用
      show-details: ${MANAGEMENT_HEALTH_SHOW_DETAILS:always}

