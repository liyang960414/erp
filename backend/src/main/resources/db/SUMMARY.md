# æ•°æ®åº“è„šæœ¬æ€»è§ˆ

æœ¬ç›®å½•åŒ…å«å®Œæ•´çš„æ•°æ®åº“ç®¡ç†è„šæœ¬ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€åˆå§‹æ•°æ®å’Œè‡ªåŠ¨åŒ–å·¥å…·ã€‚

## ğŸ“‹ æ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `init_all.sql` | SQL | **å®Œæ•´åˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰â­** |
| `drop_all_tables.sql` | SQL | åˆ é™¤æ‰€æœ‰è¡¨ |
| `recreate_database.sh` | Shell | Linux/Macè‡ªåŠ¨åŒ–é‡å»ºè„šæœ¬ |
| `recreate_database.bat` | Batch | Windowsè‡ªåŠ¨åŒ–é‡å»ºè„šæœ¬ |
| `QUERY_EXAMPLES.sql` | SQL | æŸ¥è¯¢ç¤ºä¾‹è„šæœ¬ |
| `migration/` | ç›®å½• | æ•°æ®åº“è¿ç§»è„šæœ¬ç›®å½• |
| `README.md` | æ–‡æ¡£ | è¯¦ç»†ä½¿ç”¨è¯´æ˜ |
| `SUMMARY.md` | æ–‡æ¡£ | æœ¬æ–‡ä»¶ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼1: ä½¿ç”¨å®Œæ•´åˆå§‹åŒ–è„šæœ¬ï¼ˆæœ€ç®€å•ï¼Œæ¨èï¼‰

```bash
# ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰åˆå§‹åŒ–
psql -h localhost -p 5432 -U postgres -d erp_db -f init_all.sql
```

### æ–¹å¼2: è‡ªåŠ¨åŒ–é‡å»º

#### Windowsç”¨æˆ·
```batch
cd backend\src\main\resources\db
recreate_database.bat
```

#### Linux/Macç”¨æˆ·
```bash
cd backend/src/main/resources/db
chmod +x recreate_database.sh
./recreate_database.sh
```

### æ–¹å¼3: æ‰‹åŠ¨æ‰§è¡ŒSQL

```bash
# è¿æ¥åˆ°æ•°æ®åº“
psql -h localhost -p 5432 -U postgres -d erp_db

# åœ¨psqlä¸­æ‰§è¡Œ
\i init_all.sql
```

## ğŸ“Š æ•°æ®åº“ç»“æ„

### è¡¨å…³ç³»

```
users (ç”¨æˆ·)
  â†“ (å¤šå¯¹å¤š)
user_roles (ç”¨æˆ·è§’è‰²å…³è”)
  â†“
roles (è§’è‰²)
  â†“ (å¤šå¯¹å¤š)
role_permissions (è§’è‰²æƒé™å…³è”)
  â†“
permissions (æƒé™)

audit_logs (å®¡è®¡æ—¥å¿—è¡¨ - ç‹¬ç«‹è¡¨)

unit_groups (å•ä½ç»„)
  â†“ (ä¸€å¯¹å¤š)
units (å•ä½)
  â†“ (ä¸€å¯¹å¤š)
unit_conversions (å•ä½è½¬æ¢)

material_groups (ç‰©æ–™ç»„ - æ ‘å½¢ç»“æ„)
  â†“ (ä¸€å¯¹å¤š)
materials (ç‰©æ–™)
```

### è¡¨åˆ—è¡¨

| è¡¨å | è¯´æ˜ | ä¸»é”® |
|------|------|------|
| users | ç”¨æˆ·è¡¨ | id |
| roles | è§’è‰²è¡¨ | id |
| permissions | æƒé™è¡¨ | id |
| user_roles | ç”¨æˆ·è§’è‰²å…³è” | (user_id, role_id) |
| role_permissions | è§’è‰²æƒé™å…³è” | (role_id, permission_id) |
| audit_logs | å®¡è®¡æ—¥å¿—è¡¨ | id |
| unit_groups | å•ä½ç»„è¡¨ | id |
| units | å•ä½è¡¨ | id |
| unit_conversions | å•ä½è½¬æ¢è¡¨ | id |
| material_groups | ç‰©æ–™ç»„è¡¨ï¼ˆæ”¯æŒæ ‘å½¢ç»“æ„ï¼‰ | id |
| materials | ç‰©æ–™è¡¨ | id |

### é‡è¦å­—æ®µç±»å‹è¯´æ˜

**materials è¡¨**ï¼š
- æ–‡æœ¬å­—æ®µï¼ˆname, specification, mnemonic_code, descriptionï¼‰ä½¿ç”¨ **TEXT** ç±»å‹
- æ”¯æŒä»»æ„é•¿åº¦çš„æ•°æ®å¯¼å…¥ï¼Œé¿å… VARCHAR é•¿åº¦é™åˆ¶

**material_groups è¡¨**ï¼š
- name å­—æ®µä½¿ç”¨ **TEXT** ç±»å‹
- æ”¯æŒé•¿ç‰©æ–™ç»„åç§°

## ğŸ” é»˜è®¤è´¦æˆ·

### ç®¡ç†å‘˜è´¦æˆ·
- **ç”¨æˆ·å**: admin
- **å¯†ç **: admin123
- **è§’è‰²**: ADMIN
- **æƒé™**: å…¨éƒ¨

### æµ‹è¯•è´¦æˆ·
- **ç”¨æˆ·å**: testuser
- **å¯†ç **: admin123
- **è§’è‰²**: USER
- **æƒé™**: æŸ¥çœ‹æƒé™

## ğŸ”§ å¸¸ç”¨æ“ä½œ

### å®Œå…¨é‡å»ºæ•°æ®åº“
```bash
./recreate_database.sh  # Linux/Mac
recreate_database.bat   # Windows
```

### åªåˆ é™¤è¡¨
```bash
psql -h localhost -U postgres -d erp_db -f drop_all_tables.sql
```

### åªé‡å»ºæ•°æ®åº“
```bash
psql -h localhost -U postgres -d erp_db -f init_all.sql
```

### æ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆåœ¨ç°æœ‰æ•°æ®åº“ä¸Šæ·»åŠ æ–°åŠŸèƒ½ï¼‰
```bash
# æ·»åŠ ä¾›åº”å•†è¡¨å’Œç›¸å…³æƒé™
psql -h localhost -U postgres -d erp_db -f migration/001_add_suppliers_table.sql
```

### å¤‡ä»½æ•°æ®åº“
```bash
pg_dump -h localhost -U postgres erp_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

### æ¢å¤æ•°æ®åº“
```bash
psql -h localhost -U postgres -d erp_db < backup_20240101_120000.sql
```

## ğŸ“ è„šæœ¬è¯´æ˜

### init_all.sql
- **ä¸€æ¬¡æ€§å®Œæ•´åˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰â­**
- åˆ é™¤æ‰€æœ‰ç°æœ‰è¡¨
- åˆ›å»ºæ‰€æœ‰è¡¨ç»“æ„å’Œç´¢å¼•
- æ’å…¥æ‰€æœ‰åˆå§‹æ•°æ®
- éªŒè¯æ•°æ®å®Œæ•´æ€§

**ç‰¹æ€§**:
- äº‹åŠ¡æ”¯æŒï¼Œå¯å›æ»š
- å•ä¸€æ–‡ä»¶ï¼Œä½¿ç”¨ç®€å•
- åŒ…å«å®Œæ•´çš„è¡¨æ³¨é‡Šå’Œåˆ—æ³¨é‡Š
- è‡ªåŠ¨éªŒè¯åˆå§‹åŒ–ç»“æœ

**åŒ…å«å†…å®¹**:
- æƒé™ç³»ç»Ÿï¼šusers, roles, permissions, user_roles, role_permissions
- å®¡è®¡ç³»ç»Ÿï¼šaudit_logs
- å•ä½ç®¡ç†ï¼šunit_groups, units, unit_conversions
- ç‰©æ–™ç®¡ç†ï¼šmaterial_groups, materials
- æ‰€æœ‰ç´¢å¼•å’Œå¤–é”®çº¦æŸ
- é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼ˆadmin/admin123ï¼‰å’Œæµ‹è¯•è´¦æˆ·ï¼ˆtestuser/admin123ï¼‰

### drop_all_tables.sql
- åˆ é™¤æ‰€æœ‰è¡¨
- ä½¿ç”¨CASCADEç¡®ä¿åˆ é™¤å¤–é”®å…³è”

**âš ï¸ è­¦å‘Š**: æ­¤è„šæœ¬ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼

### recreate_database.sh/bat
- è‡ªåŠ¨æ£€æŸ¥æ•°æ®åº“è¿æ¥
- äº¤äº’å¼ç¡®è®¤åˆ é™¤
- æ‰§è¡Œå®Œæ•´é‡å»ºæµç¨‹
- éªŒè¯æ•°æ®å®Œæ•´æ€§
- å½©è‰²è¾“å‡ºæç¤º

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°è¡¨

1. åœ¨ `init_all.sql` ä¸­æ·»åŠ CREATE TABLEè¯­å¥
2. æ·»åŠ ç´¢å¼•å’Œæ³¨é‡Š
3. æ›´æ–°æ–‡æ¡£

### æ·»åŠ åˆå§‹æ•°æ®

1. åœ¨ `init_all.sql` ä¸­æ·»åŠ INSERTè¯­å¥
2. ä½¿ç”¨ `ON CONFLICT DO NOTHING`
3. æ·»åŠ éªŒè¯æŸ¥è¯¢

### ä¿®æ”¹è¡¨ç»“æ„

1. **å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨JPAè‡ªåŠ¨æ›´æ–°
```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: update
```

2. **ç”Ÿäº§ç¯å¢ƒ**: åˆ›å»ºè¿ç§»è„šæœ¬
   - åœ¨ `migration/` ç›®å½•ä¸‹åˆ›å»ºè¿ç§»è„šæœ¬
   - ä½¿ç”¨ `IF NOT EXISTS` ç¡®ä¿è„šæœ¬å¯é‡å¤æ‰§è¡Œ
   - åˆ›å»ºå¯¹åº”çš„å›æ»šè„šæœ¬
   - å‚è€ƒ `migration/001_add_suppliers_table.sql` ä½œä¸ºç¤ºä¾‹

ç¤ºä¾‹ï¼š
```bash
# æ‰§è¡Œè¿ç§»è„šæœ¬
psql -h localhost -U postgres -d erp_db -f migration/001_add_suppliers_table.sql

# å¦‚æœéœ€è¦å›æ»š
psql -h localhost -U postgres -d erp_db -f migration/001_add_suppliers_table_rollback.sql
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **å¼€å‘ç¯å¢ƒ**:
   - å¯ä»¥ä½¿ç”¨é»˜è®¤è´¦æˆ·
   - å®šæœŸé‡å»ºæ•°æ®åº“
   - ä¸è¦æäº¤æ•æ„Ÿæ•°æ®

2. **æµ‹è¯•ç¯å¢ƒ**:
   - ä¿®æ”¹é»˜è®¤å¯†ç 
   - åˆ›å»ºæµ‹è¯•è´¦æˆ·
   - å®šæœŸæ¸…ç†æ•°æ®

3. **ç”Ÿäº§ç¯å¢ƒ**:
   - ä¸è¦ä½¿ç”¨è¿™äº›è„šæœ¬ï¼
   - æ‰‹åŠ¨åˆ›å»ºè¡¨ç»“æ„
   - ä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·
   - ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
   - å¯ç”¨æ•°æ®åº“å®¡è®¡

## â“ æ•…éšœæ’æŸ¥

### è¿æ¥å¤±è´¥
```
é”™è¯¯: æ— æ³•è¿æ¥åˆ°PostgreSQL
è§£å†³: æ£€æŸ¥PostgreSQLæœåŠ¡æ˜¯å¦è¿è¡Œ
     æ£€æŸ¥è¿æ¥å‚æ•°æ˜¯å¦æ­£ç¡®
```

### æƒé™ä¸è¶³
```
é”™è¯¯: permission denied
è§£å†³: ç¡®ä¿ä½¿ç”¨postgresç”¨æˆ·
     æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™
```

### è¡¨å·²å­˜åœ¨
```
é”™è¯¯: relation already exists
è§£å†³: å…ˆæ‰§è¡Œdrop_all_tables.sql
     æˆ–ä½¿ç”¨recreate_databaseè„šæœ¬
```

### å¤–é”®çº¦æŸ
```
é”™è¯¯: foreign key constraint failed
è§£å†³: æŒ‰æ­£ç¡®é¡ºåºåˆ é™¤è¡¨
     æˆ–ä½¿ç”¨CASCADEé€‰é¡¹
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†ä½¿ç”¨è¯´æ˜](README.md)
- [è¿ç§»è„šæœ¬è¯´æ˜](migration/README.md)
- [è®¤è¯ç³»ç»Ÿæ–‡æ¡£](../../AUTH_README.md)
- [APIæµ‹è¯•ç¤ºä¾‹](../../API_TEST_EXAMPLES.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](../../QUICKSTART.md)

## ğŸ”„ ç‰ˆæœ¬å†å²

### v3.2 (2024-12-XX)
- **æ–°å¢**: ä¾›åº”å•†ç®¡ç†ç›¸å…³è¡¨ï¼ˆsuppliersï¼‰
- **æ–°å¢**: ä¾›åº”å•†å¯¼å…¥æƒé™ï¼ˆsupplier:importï¼‰
- **æ–°å¢**: æ•°æ®åº“è¿ç§»è„šæœ¬ç³»ç»Ÿï¼ˆmigrationç›®å½•ï¼‰
- **æ–°å¢**: è¿ç§»è„šæœ¬ `001_add_suppliers_table.sql`
- **æ–°å¢**: å›æ»šè„šæœ¬ `001_add_suppliers_table_rollback.sql`

### v3.1 (2024-12-XX)
- **æ–°å¢**: ç‰©æ–™ç®¡ç†ç›¸å…³è¡¨ï¼ˆmaterials, material_groupsï¼‰
- **æ–°å¢**: å•ä½ç®¡ç†ç›¸å…³è¡¨ï¼ˆunits, unit_groups, unit_conversionsï¼‰
- **æ–°å¢**: å®¢æˆ·ç®¡ç†ç›¸å…³è¡¨ï¼ˆcustomersï¼‰
- **æ–°å¢**: é”€å”®è®¢å•ç›¸å…³è¡¨ï¼ˆsale_orders, sale_order_itemsï¼‰
- **ä¿®å¤**: ç‰©æ–™å¯¼å…¥æ—¶çš„å­—æ®µé•¿åº¦é™åˆ¶é—®é¢˜
- **ä¼˜åŒ–**: ä½¿ç”¨ TEXT ç±»å‹æ”¯æŒé•¿æ–‡æœ¬æ•°æ®å¯¼å…¥
- **æ›´æ–°**: å®ä½“ç±»æ˜ å°„ä»¥åŒ¹é…æ•°æ®åº“ç»“æ„

### v3.0 (2024-12-20)
- **æ–°å¢**: å®¡è®¡æ—¥å¿—è¡¨ï¼ˆaudit_logsï¼‰
- **æ–°å¢**: init_all.sqlå®Œæ•´åˆå§‹åŒ–è„šæœ¬
- **æ›´æ–°**: æ‰€æœ‰æ–‡æ¡£å’Œè„šæœ¬æ”¯æŒå®¡è®¡è¡¨
- **ä¼˜åŒ–**: åˆå§‹åŒ–æµç¨‹

### v1.0 (2024-01-01)
- åˆå§‹ç‰ˆæœ¬
- å®Œæ•´çš„è¡¨ç»“æ„
- åŸºç¡€æƒé™ç³»ç»Ÿ
- è‡ªåŠ¨åŒ–è„šæœ¬

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ [README.md](README.md)
2. æ£€æŸ¥é”™è¯¯æ—¥å¿—
3. å‚è€ƒPostgreSQLæ–‡æ¡£
4. è”ç³»å¼€å‘å›¢é˜Ÿ

