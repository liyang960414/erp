# 后台任务类型统计文档

## 概述

本文档统计了 ERP 系统中所有后台导入任务类型，包括任务类型定义、处理器实现、依赖关系等信息。

## 任务类型列表

系统共支持 **8 种**后台导入任务类型，如下表所示：

| 序号 | 任务类型标识 | 任务类型名称 | 处理器类 | 处理服务类 |
|------|------------|------------|---------|-----------|
| 1 | `unit` | 单位导入 | `UnitImportTaskHandler` | `UnitImportService` |
| 2 | `supplier` | 供应商导入 | `SupplierImportTaskHandler` | `SupplierImportService` |
| 3 | `material` | 物料导入 | `MaterialImportTaskHandler` | `MaterialImportService` |
| 4 | `bom` | BOM导入 | `BomImportTaskHandler` | `BomImportService` |
| 5 | `purchase-order` | 采购订单导入 | `PurchaseOrderImportTaskHandler` | `PurchaseOrderImportService` |
| 6 | `sale-order` | 销售订单导入 | `SaleOrderImportTaskHandler` | `SaleOrderImportService` |
| 7 | `sale-outstock` | 销售出库单导入 | `SaleOutstockImportTaskHandler` | `SaleOutstockImportService` |
| 8 | `sub-req-order` | 委外订单导入 | `SubReqOrderImportTaskHandler` | `SubReqOrderImportService` |

## 任务类型详情

### 1. 单位导入 (unit)

- **任务类型标识**: `unit`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.UnitImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.UnitImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/UnitImportTaskHandler.java`
- **说明**: 用于导入单位数据，包括单位组和单位信息

### 2. 供应商导入 (supplier)

- **任务类型标识**: `supplier`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.SupplierImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.SupplierImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/SupplierImportTaskHandler.java`
- **说明**: 用于导入供应商基础信息

### 3. 物料导入 (material)

- **任务类型标识**: `material`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.MaterialImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.MaterialImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/MaterialImportTaskHandler.java`
- **说明**: 用于导入物料数据，包括物料组和物料信息
- **依赖关系**: 依赖 `unit` 任务类型

### 4. BOM导入 (bom)

- **任务类型标识**: `bom`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.BomImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.BomImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/BomImportTaskHandler.java`
- **说明**: 用于导入物料清单（Bill of Materials）数据，包括BOM主表和BOM明细项
- **依赖关系**: 依赖 `material` 任务类型

### 5. 采购订单导入 (purchase-order)

- **任务类型标识**: `purchase-order`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.PurchaseOrderImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.PurchaseOrderImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/PurchaseOrderImportTaskHandler.java`
- **说明**: 用于导入采购订单数据
- **依赖关系**: 依赖 `material`、`supplier` 和 `sub-req-order` 任务类型

### 6. 销售订单导入 (sale-order)

- **任务类型标识**: `sale-order`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.SaleOrderImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.SaleOrderImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/SaleOrderImportTaskHandler.java`
- **说明**: 用于导入销售订单数据
- **依赖关系**: 依赖 `material` 和 `supplier` 任务类型

### 7. 销售出库单导入 (sale-outstock)

- **任务类型标识**: `sale-outstock`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.SaleOutstockImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.SaleOutstockImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/SaleOutstockImportTaskHandler.java`
- **说明**: 用于导入销售出库单数据
- **依赖关系**: 依赖 `sale-order` 任务类型

### 8. 委外订单导入 (sub-req-order)

- **任务类型标识**: `sub-req-order`
- **处理器类**: `com.sambound.erp.service.importing.task.handler.SubReqOrderImportTaskHandler`
- **处理服务类**: `com.sambound.erp.service.SubReqOrderImportService`
- **处理器类路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/handler/SubReqOrderImportTaskHandler.java`
- **说明**: 用于导入委外订单数据
- **依赖关系**: 依赖 `material`、`supplier` 和 `bom` 任务类型

## 任务依赖关系

系统支持任务之间的依赖关系配置，确保前置任务完成后才执行后续任务。依赖关系配置在 `application.yaml` 中：

```yaml
erp:
  import:
    dependencies:
      material:
        - unit
      bom:
        - material
      purchase-order:
        - material
        - supplier
        - sub-req-order
      sale-order:
        - material
        - supplier
      sale-outstock:
        - sale-order
      sub-req-order:
        - material
        - supplier
        - bom
```

### 依赖关系图

```
unit (单位)
  └─> material (物料)
        ├─> bom (BOM)
        │     └─> sub-req-order (委外订单)
        ├─> purchase-order (采购订单)
        ├─> sale-order (销售订单)
        │     └─> sale-outstock (销售出库单)
        └─> sub-req-order (委外订单)

supplier (供应商)
  ├─> purchase-order (采购订单)
  ├─> sale-order (销售订单)
  │     └─> sale-outstock (销售出库单)
  └─> sub-req-order (委外订单)

bom (BOM)
  └─> sub-req-order (委外订单)

sub-req-order (委外订单)
  └─> purchase-order (采购订单)
```

### 依赖关系说明

1. **material** 依赖 **unit**: 物料导入需要先完成单位导入，因为物料需要使用单位信息
2. **bom** 依赖 **material**: BOM导入需要先完成物料导入，因为BOM需要引用物料
3. **sub-req-order** 依赖 **material**、**supplier** 和 **bom**: 委外订单需要物料、供应商和BOM信息
4. **purchase-order** 依赖 **material**、**supplier** 和 **sub-req-order**: 采购订单需要物料、供应商和委外订单信息
5. **sale-order** 依赖 **material** 和 **supplier**: 销售订单需要物料和供应商信息
6. **sale-outstock** 依赖 **sale-order**: 销售出库单需要先完成销售订单导入

## 任务并发配置

系统支持为每种任务类型配置最大并发数，配置在 `application.yaml` 中：

```yaml
erp:
  import:
    type-concurrency:
      unit: 1
      material: 1
      bom: 1
      sub-req-order: 1
```

未配置的任务类型使用全局最大并发数（默认 4）。

## 任务状态

所有任务支持以下状态：

- `WAITING`: 等待中（等待依赖任务完成）
- `QUEUED`: 排队中（依赖已满足，等待执行）
- `RUNNING`: 运行中
- `COMPLETED`: 已完成
- `FAILED`: 已失败
- `CANCELLED`: 已取消

## 核心组件

### 任务管理器
- **类名**: `ImportTaskManager`
- **路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/ImportTaskManager.java`
- **功能**: 负责创建、查询、重试导入任务

### 任务调度器
- **类名**: `ImportTaskScheduler`
- **路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/ImportTaskScheduler.java`
- **功能**: 负责检测依赖、调度任务执行

### 任务处理器接口
- **接口名**: `ImportTaskHandler`
- **路径**: `backend/src/main/java/com/sambound/erp/service/importing/task/ImportTaskHandler.java`
- **功能**: 定义任务处理器的标准接口

## 文件结构

```
backend/src/main/java/com/sambound/erp/service/importing/
├── task/
│   ├── handler/                    # 任务处理器实现
│   │   ├── BomImportTaskHandler.java
│   │   ├── MaterialImportTaskHandler.java
│   │   ├── PurchaseOrderImportTaskHandler.java
│   │   ├── SaleOrderImportTaskHandler.java
│   │   ├── SaleOutstockImportTaskHandler.java
│   │   ├── SubReqOrderImportTaskHandler.java
│   │   ├── SupplierImportTaskHandler.java
│   │   └── UnitImportTaskHandler.java
│   ├── ImportTaskHandler.java      # 处理器接口
│   ├── ImportTaskManager.java      # 任务管理器
│   └── ImportTaskScheduler.java    # 任务调度器
├── dto/                            # 数据传输对象
│   ├── BomExcelRow.java
│   ├── MaterialExcelRow.java
│   ├── PurchaseOrderExcelRow.java
│   ├── SaleOrderExcelRow.java
│   ├── SaleOutstockExcelRow.java
│   ├── SubReqOrderExcelRow.java
│   ├── SupplierExcelRow.java
│   └── UnitExcelRow.java
└── ...
```

## 统计汇总

- **任务类型总数**: 8
- **有依赖关系的任务**: 6 (material, bom, purchase-order, sale-order, sale-outstock, sub-req-order)
- **无依赖关系的任务**: 2 (unit, supplier)
- **处理器实现类**: 8
- **支持的任务状态**: 6

## 更新日期

文档生成日期: 2024年

## 备注

1. 所有任务处理器都实现了 `ImportTaskHandler` 接口
2. 任务类型标识必须与前端提交的类型一致
3. 依赖关系通过 `ImportDependencyProperties` 配置类管理
4. 任务调度采用定时轮询机制，默认每 2 秒检查一次待执行任务

